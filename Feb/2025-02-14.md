## 날짜: 2025-02-14

## JWT가 탈취 당했을 때 해결법

- Access token만으로 재발급을 받을 수 없도록 Refresh token을 함께 사용한다.
- 즉시 토큰을 폐기시키고, Acceess token과 Refresh token을 재발급
- Refresh Token Rotation : Refresh token으로 Access token을 재발급 했다면 Refresh token도 재발급한다.

## JWT 탈취

- JWT는 서버가 아닌 클라이언트에 저장된다. 그러다보니 토큰에 대해 접근하기가 더 쉽다.
- JWT를 어디에 저장하는지에 따라 취약해지는 공격이 달라진다.

### JWT 저장 공간

- 로컬 스토리지 : 브라우저에 반영구적으로 저장이 가능한 공간. 브라우저가 닫혀도 데이터가 남아있다.
- 세션 스토리지 : 로컬 스토리지와 비슷하지만 브라우저가 닫히면 데이터는 사라진다.
- 두 스토리지는 모두 자바스크립트 코드로 관리가 될 수 있어서 XSS 공격에 대한 위험이 있다.
- 쿠키 : 웹 사이트의 정보를 작은 조각으로 사용자의 장치에 저장하는 파일.
- 쿠키는 요청을 보낼 때 자동으로 쿠키에 담긴 정보를 통으로 보내기 때문에 공격자가 인증된 사용자를 통해 CSRF 공격을 할 수 있다.

### XSS(Cross Site Scripting)

- 공격자가 웹에 스크립트 코드를 삽입해서 원치 않는 기능을 동작시키는 공격이다.
- 만약 JWT가 스크립트로 접근할 수 있는 곳에 저장되어 있다면 탈취될 수 있다.
- ex) 댓글 입력란에 `<script>` 태그를 넣어서 입력하면 스크립트가 실행 된다.
- 해결법
  - html 태그를 이스케이프 처리하여 사용자가 스크립트를 입력하지 못하게 제한을 한다.
  - CSP(Content Security Policy)를 적용하여 허용된 도메인의 스크립트만 실행할 수 있도록 한다.
  - Httponly 속성을 이용하여 스크립트 코드가 쿠키에 접근하지 못하게 한다.

### CSRF(Cross Site Request Forgery)

- 웹사이트가 신뢰하는 유저로부터 권한이 없는 커맨드(수정, 삭제, 등록 등)를 받는 공격.
- 엄밀히 말하자면 사용자의 정보, 토큰을 탈취하는 것이 아닌 인증된 사용자를 통해 공격하는 것.
- ex) 공격자가 웹사이트가 신뢰하는 유저에게 악성 링크를 보낸다. 이 링크는 커맨드를 실행시키는 링크가 될 수 있다.
- 해결법
  - CSRF 토큰 사용 : CSRF토큰을 서버와 클라이언트 모두에 저장하여 중요한 커맨드 또는 요청을 보낼때는 CSRF 토큰도 같이 보낸다. 서버에 있는 CSRF 토큰과 같은지 검증을 하고 요청을 처리한다.
  - `SameSite`  옵션을 이용 : 쿠키를 전송할 범위를 설정하는 옵션이다. 다른 사이트에서 들어온 요청은 쿠키를 보내지 않거나, Get 메서드 요청에만 보내줄 수 있다.